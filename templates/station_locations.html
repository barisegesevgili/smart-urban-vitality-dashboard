{% extends "base.html" %}

{% block title %}Smart-Urban-Vitality - Station Locations{% endblock %}

{% block extra_head %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNF6uExCzzggGGH2rlu2ljvf6SfOINtbY"></script>
<style>
    #map {
        height: 70vh;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    .info-window {
        padding: 10px;
        max-width: 300px;
    }
    .info-window h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #333;
    }
    .info-window p {
        margin: 5px 0;
        color: #666;
    }
    .info-window .value {
        font-weight: bold;
        color: #333;
    }
    .no-data {
        color: #999;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">Station Locations</h1>
    <div id="map"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function createInfoWindowContent(station, data) {
        if (data.status === 'no_data') {
            return `
                <div class="info-window">
                    <h3>${station.name}</h3>
                    <p class="no-data">No data available for this station</p>
                </div>
            `;
        }

        return `
            <div class="info-window">
                <h3>${station.name}</h3>
                <p>Temperature: <span class="value">${data.temperature}Â°C</span></p>
                <p>Humidity: <span class="value">${data.humidity}%</span></p>
                <p>UV Index: <span class="value">${data.uv_index}</span></p>
                <p>Air Quality: <span class="value">${data.air_quality}</span></p>
                <p>CO2e: <span class="value">${data.co2e} ppm</span></p>
                <p>Fill Level: <span class="value">${data.fill_level}%</span></p>
                <p>Last Updated: <span class="value">${formatDateTime(data.rtc_time)}</span></p>
            </div>
        `;
    }

    function initMap() {
        console.log('Initializing map...');
        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 11,
            center: { lat: 48.1500, lng: 11.5833 }, // Munich center
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });

        const stations = [
            { 
                id: 1,
                name: 'Englischer Garten',
                position: { lat: 48.1500, lng: 11.5833 }
            },
            { 
                id: 2,
                name: 'Garching TUM Campus',
                position: { lat: 48.2620, lng: 11.6670 }
            },
            { 
                id: 3,
                name: 'Garching Mensa',
                position: { lat: 48.2510, lng: 11.6520 }
            }
        ];

        stations.forEach(station => {
            console.log(`Creating marker for station ${station.name}`);
            const marker = new google.maps.Marker({
                position: station.position,
                map: map,
                title: station.name,
                animation: google.maps.Animation.DROP
            });

            marker.addListener('click', () => {
                console.log(`Fetching data for station ${station.id}`);
                fetch(`/sensor_data/${station.id}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Received data:', data);
                        const content = createInfoWindowContent(station, data);
                        const infoWindow = new google.maps.InfoWindow({
                            content: content
                        });
                        infoWindow.open(map, marker);
                    })
                    .catch(error => {
                        console.error('Error fetching station data:', error);
                        const content = createInfoWindowContent(station, { status: 'no_data' });
                        const infoWindow = new google.maps.InfoWindow({
                            content: content
                        });
                        infoWindow.open(map, marker);
                    });
            });
        });
    }

    // Initialize map when the page loads
    window.onload = function() {
        console.log('Page loaded, initializing map...');
        initMap();
    };
</script>
{% endblock %} 